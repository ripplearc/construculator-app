<?xml version="1.0" encoding="UTF-8"?>
<mutations version="1.0">
   <files>
        <file>lib/libraries/supabase/testing/fake_supabase_wrapper.dart</file>
    </files>
      <rules>
        <!-- RULE 1: Invert conditional error throwing. If it's supposed to throw, don't. -->
        <regex pattern="if\s*\((shouldThrowOn[A-Z][a-zA-Z]+)\)\s*\{" dotAll="true" id="fakes.errors.skip_configured_throw">
            <mutation text="if (!$1) {"/>
        </regex>

        <!-- RULE 2: In `signInWithPassword`, fail to notify auth state listeners after success. -->
        <regex pattern="(_authStateController\.add\(_createAuthState\(supabase\.AuthChangeEvent\.signedIn, user\)\);)" dotAll="true" id="fakes.auth.signin_fails_to_notify">
            <mutation text="// $1"/>
        </regex>

        <!-- RULE 3: In `signOut`, fail to clear the current user. -->
        <regex pattern="(_currentUser\s*=\s*null;)" dotAll="true" id="fakes.auth.signout_fails_to_clear_user">
            <mutation text="// $1"/>
        </regex>

        <!-- RULE 4: In `signOut`, fail to notify auth state listeners. -->
        <regex pattern="(_authStateController\.add\(_createAuthState\(supabase\.AuthChangeEvent\.signedOut, null\)\);)" dotAll="true" id="fakes.auth.signout_fails_to_notify">
            <mutation text="// $1"/>
        </regex>

        <!-- RULE 5: Force `isAuthenticated` to always be true. -->
        <regex pattern="(bool\s+get\s+isAuthenticated\s*=>\s*_currentUser\s*!=\s*null;)" dotAll="true" id="fakes.auth.force_authenticated">
            <mutation text="bool get isAuthenticated => true;"/>
        </regex>

        <!-- RULE 6: In `selectSingle`, if a record is found, return null instead. -->
        <regex pattern="(if\s*\(row\[filterColumn\]\s*==\s*filterValue\)\s*\{)" dotAll="true" id="fakes.db.select_returns_null_on_match">
            <mutation text="$1 return null;"/>
        </regex>

        <!-- RULE 7: In `insert`, add the wrong data to the table. -->
        <regex pattern="(tableData\.add\(insertData\);)" dotAll="true" id="fakes.db.insert_adds_wrong_data">
            <mutation text="tableData.add({'mutated': 'data'});"/>
        </regex>

        <!-- RULE 8: In `update`, do not apply the update to the table data. -->
        <regex pattern="(tableData\[i\]\s*=\s*updatedData;)" dotAll="true" id="fakes.db.update_fails_to_apply">
            <mutation text="// $1"/>
        </regex>

        <!-- RULE 9: In `update`, return the old data instead of the updated data. -->
        <regex pattern="(return\s*Map&lt;String, dynamic&gt;\.from\(updatedData\);)" dotAll="true" id="fakes.db.update_returns_old_data">
            <mutation text="return Map&lt;String, dynamic&gt;.from(tableData[i]);"/>
        </regex>

        <!-- RULE 10: In `_throwConfiguredException`, always throw a generic exception. -->
        <regex pattern="(switch\s*\(exceptionType\)\s*\{)" dotAll="true" id="fakes.errors.throw_generic_exception">
            <mutation text="throw Exception(message); $1"/>
        </regex>

        <!-- RULE 11: In `reset`, fail to reset one of the boolean flags. -->
        <regex pattern="(shouldThrowOnSignIn\s*=\s*false;)" dotAll="true" id="fakes.state.reset_fails_for_flag">
            <mutation text="// $1"/>
        </regex>

        <!-- RULE 12: In `clearAllData`, fail to clear the tables. -->
        <regex pattern="(_tables\.clear\(\);)" dotAll="true" id="fakes.state.clear_fails_for_tables">
            <mutation text="// $1"/>
        </regex>

        <!-- RULE 13: In `selectPaginated`, invert filter comparison (== to !=). -->
        <regex pattern="(\.where\(\(row\) => row\[filterColumn\] == filterValue\))" dotAll="true" id="fakes.db.select_paginated_invert_filter">
            <mutation text=".where((row) => row[filterColumn] != filterValue)"/>
        </regex>

        <!-- RULE 14: In `selectPaginated`, off-by-one error in rangeTo calculation (remove +1). -->
        <regex pattern="(final to = \(rangeTo \+ 1\)\.clamp\(0, filteredData\.length\);)" dotAll="true" id="fakes.db.select_paginated_rangeto_off_by_one">
            <mutation text="final to = rangeTo.clamp(0, filteredData.length);"/>
        </regex>

        <!-- RULE 15: In `selectPaginated`, invert ascending/descending order. -->
        <regex pattern="(return ascending \? aVal\.compareTo\(bVal\) : bVal\.compareTo\(aVal\);)" dotAll="true" id="fakes.db.select_paginated_invert_order">
            <mutation text="return ascending ? bVal.compareTo(aVal) : aVal.compareTo(bVal);"/>
        </regex>

        <!-- RULE 16: In `selectPaginated`, skip filtering before pagination. -->
        <regex pattern="(var filteredData = tableData[\s\S]*?\.where\(\(row\) => row\[filterColumn\] == filterValue\)[\s\S]*?\.toList\(\);)" dotAll="true" id="fakes.db.select_paginated_skip_filter">
            <mutation text="var filteredData = tableData;"/>
        </regex>

        <!-- RULE 17: In `selectPaginated`, return unfiltered data. -->
        <regex pattern="(return filteredData\.sublist\(from, to\);)" dotAll="true" id="fakes.db.select_paginated_return_unfiltered">
            <mutation text="return tableData.sublist(from, to);"/>
        </regex>

        <!-- RULE 18: In `rpc`, return null instead of configured response. -->
        <regex pattern="(if \(_rpcResponses\.containsKey\(functionName\)\) \{[\s\S]*?return _rpcResponses\[functionName\] as T;[\s\S]*?\})" dotAll="true" id="fakes.rpc.return_null_instead_of_response">
            <mutation text="if (_rpcResponses.containsKey(functionName)) { return null as T; }"/>
        </regex>

        <!-- RULE 19: In `rpc`, skip throwing configured exception. -->
        <regex pattern="(if \(shouldThrowOnRpc\) \{[\s\S]*?_throwConfiguredException\([\s\S]*?\);[\s\S]*?\})" dotAll="true" id="fakes.rpc.skip_throw_exception">
            <mutation text="// exception skipped"/>
        </regex>

        <!-- RULE 20: In `rpc`, return wrong function's response. -->
        <regex pattern="(return _rpcResponses\[functionName\] as T;)" dotAll="true" id="fakes.rpc.return_wrong_response">
            <mutation text="return _rpcResponses.values.first as T;"/>
        </regex>
    </rules>

    <commands>
           <command group="fake_supabase_wrapper_auth_methods" expected-return="0">flutter test test/libraries/supabase/units/fakes/fake_supabase_wrapper_test.dart</command>
            </commands>

    <threshold failure="85">
        <rating over="85" name="A"/>
        <rating over="75" name="B"/>
        <rating over="65" name="C"/>
        <rating over="55" name="D"/>
        <rating over="35" name="E"/>
        <rating over="0" name="F"/>
    </threshold>
</mutations> 